package application;

import javafx.animation.Animation;
import javafx.animation.KeyFrame;
import javafx.animation.Timeline;
import javafx.application.Application;
import javafx.event.EventHandler;
import javafx.scene.Scene;
import javafx.scene.control.Alert;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.input.KeyEvent;
import javafx.scene.layout.AnchorPane;
import javafx.scene.paint.Color;
import javafx.scene.shape.Circle;
import javafx.scene.shape.Rectangle;
import javafx.scene.text.Font;
import javafx.scene.text.Text;
import javafx.stage.Stage;
import javafx.util.Duration;

import java.util.ArrayList;
import java.util.List;

/**
 * OceanExplorer - Main Application Class
 * 
 * The main JavaFX application for the Christopher Columbus treasure game.
 * Manages the game window, graphics, input, and game loop.
 * 
 * @author Student
 * @version 1.0
 */
public class OceanExplorer extends Application {
    private final int dimension = 15; // 15x15 grid (larger than original 10x10)
    private final int scale = 50; // Size of each grid cell in pixels

    // Game objects
    private OceanMap oceanMap;
    private Ship ship;
    private Treasure treasure;
    private List<PirateShip> pirates = new ArrayList<>();
    private List<SeaMonster> monsters = new ArrayList<>();
    private GameController gameController;

    // Graphics objects
    private ImageView shipImageView;
    private List<ImageView> pirateImageViews = new ArrayList<>();
    private List<ImageView> monsterImageViews = new ArrayList<>();
    private ImageView treasureImageView;
    
    // UI text
    private Text statusText;
    private Text scoreText;
    private Text treasureLocationText;

    // Scene elements
    private AnchorPane root;
    private Scene scene;
    private boolean[][] oceanGrid;

    /**
     * Main entry point - launches the application
     */
    public static void main(String[] args) {
        launch(args);
    }

    /**
     * Start method - Called by JavaFX to initialize the application
     */
    @Override
    public void start(Stage oceanStage) {
        System.out.println("====START METHOD CALLED====");
        
        // Initialize game using Singleton pattern
        oceanMap = OceanMap.getInstance(dimension);
        
        // Create player ship
        ship = new Ship(1, 1, dimension);
        
        // Create treasure at random location
        treasure = new Treasure(dimension, oceanMap);
        
        // Register ship with map
        oceanMap.setShip(ship);
        
        // Place islands on map
        oceanMap.placeIslands(10);

        // CREATE PIRATES USING FACTORY PATTERN ===
        PirateShipFactory chaseFactory = new ChasePirateShipFactory();
        PirateShipFactory patrolFactory = new PatrolPirateShipFactory();
        PirateShipFactory randomFactory = new ChasePirateShipFactory(); // Could use RandomWalkFactory

        PirateShip pirate1 = chaseFactory.makePirateShip(8, 8, dimension, oceanMap);
        PirateShip pirate2 = patrolFactory.makePirateShip(4, 7, dimension, oceanMap);
        PirateShip pirate3 = chaseFactory.makePirateShip(2, 7, dimension, oceanMap);

        // Register pirates as observers (OBSERVER PATTERN)
        ship.attach(pirate1);
        ship.attach(pirate2);
        ship.attach(pirate3);

        pirates.add(pirate1);
        pirates.add(pirate2);
        pirates.add(pirate3);

        // CREATE SEA MONSTERS
        SeaMonster shark1 = new SeaMonster(12, 12, dimension, oceanMap, "Shark");
        SeaMonster kraken1 = new SeaMonster(13, 2, dimension, oceanMap, "Kraken");

        monsters.add(shark1);
        monsters.add(kraken1);

        // Create game controller
        gameController = new GameController(ship, treasure, oceanMap);
        for (PirateShip pirate : pirates) {
            gameController.addPirate(pirate);
        }
        for (SeaMonster monster : monsters) {
            gameController.addMonster(monster);
        }

        System.out.println("âœ“ Pirates created with Factory Pattern!");
        System.out.println("âœ“ Pirates registered as observers!");
        System.out.println("âœ“ Treasure location: " + treasure);
        System.out.println("âœ“ Monsters created: " + monsters.size());

        // Setup scene
        root = new AnchorPane();
        scene = new Scene(root, dimension * scale, dimension * scale + 100);

        // Draw game graphics
        drawMap();
        loadShipImage();
        loadTreasureImage();
        loadPirateImages();
        loadMonsterImages();
        createStatusDisplay();

        // Setup window
        oceanStage.setScene(scene);
        oceanStage.setTitle("Christopher Columbus - Quest for the Lost City of Gold");
        oceanStage.show();
        System.out.println("====WINDOW SHOWN===");
        
        // Start game
        startSailing();
        startGameLoop();
    }

    /**
     * Draw the ocean map with islands and water
     */
    private void drawMap() {
        oceanGrid = oceanMap.getMap();
        for (int x = 0; x < dimension; x++) {
            for (int y = 0; y < dimension; y++) {
                if (oceanGrid[x][y]) {
                    // Draw island
                    try {
                        Image islandImage = new Image("file:island.jpg", scale, scale, true, true);
                        ImageView islandView = new ImageView(islandImage);
                        islandView.setX(x * scale);
                        islandView.setY(y * scale);
                        root.getChildren().add(islandView);
                    } catch (Exception e) {
                        // Fallback to rectangle if image not found
                        Rectangle rect = new Rectangle(x * scale, y * scale, scale, scale);
                        rect.setStroke(Color.BLACK);
                        rect.setFill(Color.GREEN);
                        root.getChildren().add(rect);
                    }
                } else {
                    // Draw water
                    Rectangle rect = new Rectangle(x * scale, y * scale, scale, scale);
                    rect.setStroke(Color.BLACK);
                    rect.setFill(Color.PALETURQUOISE);
                    root.getChildren().add(rect);
                }
            }
        }
        System.out.println("âœ“ Ocean map drawn successfully!");
    }

    /**
     * Load and display the player's ship
     */
    private void loadShipImage() {
        try {
            Image shipImage = new Image("file:ship.png", scale, scale, true, true);
            shipImageView = new ImageView(shipImage);
            shipImageView.setX(ship.getShipLocation().x * scale);
            shipImageView.setY(ship.getShipLocation().y * scale);
            root.getChildren().add(shipImageView);
            System.out.println("âœ“ Ship image loaded successfully!");
        } catch (Exception e) {
            System.out.println("Could not load ship image. Using rectangle instead.");
            Rectangle shipRect = new Rectangle(
                ship.getShipLocation().x * scale, 
                ship.getShipLocation().y * scale, 
                scale, scale
            );
            shipRect.setFill(Color.RED);
            root.getChildren().add(shipRect);
            shipImageView = new ImageView();
            shipImageView.setX(ship.getShipLocation().x * scale);
            shipImageView.setY(ship.getShipLocation().y * scale);
        }
    }

    /**
     * Load and display the treasure
     */
    private void loadTreasureImage() {
        try {
            Image treasureImage = new Image("file:treasure.png", scale, scale, true, true);
            treasureImageView = new ImageView(treasureImage);
            treasureImageView.setX(treasure.getLocation().x * scale);
            treasureImageView.setY(treasure.getLocation().y * scale);
            root.getChildren().add(treasureImageView);
            System.out.println("âœ“ Treasure image loaded successfully!");
        } catch (Exception e) {
            System.out.println("Could not load treasure image. Using circle instead.");
            Circle treasureCircle = new Circle(
                treasure.getLocation().x * scale + scale / 2,
                treasure.getLocation().y * scale + scale / 2,
                scale / 3
            );
            treasureCircle.setFill(Color.GOLD);
            root.getChildren().add(treasureCircle);
            treasureImageView = new ImageView();
        }
    }

    /**
     * Load and display pirate ships
     */
    private void loadPirateImages() {
        for (PirateShip pirate : pirates) {
            try {
                Image pirateImage = new Image("file:pirateShip.png", scale, scale, true, true);
                ImageView pirateView = new ImageView(pirateImage);
                pirateView.setX(pirate.getLocation().x * scale);
                pirateView.setY(pirate.getLocation().y * scale);
                root.getChildren().add(pirateView);
                pirateImageViews.add(pirateView);
            } catch (Exception e) {
                Rectangle pirateRect = new Rectangle(
                    pirate.getLocation().x * scale,
                    pirate.getLocation().y * scale,
                    scale, scale
                );
                pirateRect.setFill(Color.BLACK);
                root.getChildren().add(pirateRect);
                ImageView pirateView = new ImageView();
                pirateImageViews.add(pirateView);
            }
        }
        System.out.println("âœ“ Pirate images loaded!");
    }

    /**
     * Load and display sea monsters
     */
    private void loadMonsterImages() {
        for (SeaMonster monster : monsters) {
            try {
                Image monsterImage = new Image("file:monster.png", scale, scale, true, true);
                ImageView monsterView = new ImageView(monsterImage);
                monsterView.setX(monster.getLocation().x * scale);
                monsterView.setY(monster.getLocation().y * scale);
                root.getChildren().add(monsterView);
                monsterImageViews.add(monsterView);
            } catch (Exception e) {
                Circle monsterCircle = new Circle(
                    monster.getLocation().x * scale + scale / 2,
                    monster.getLocation().y * scale + scale / 2,
                    scale / 3
                );
                monsterCircle.setFill(Color.PURPLE);
                root.getChildren().add(monsterCircle);
                ImageView monsterView = new ImageView();
                monsterImageViews.add(monsterView);
            }
        }
        System.out.println("âœ“ Monster images loaded!");
    }

    /**
     * Create text display for game status
     */
    private void createStatusDisplay() {
        // Status text
        statusText = new Text("Status: PLAYING");
        statusText.setFont(new Font(14));
        statusText.setX(10);
        statusText.setY(dimension * scale + 20);
        root.getChildren().add(statusText);

        // Score text
        scoreText = new Text("Score: 0");
        scoreText.setFont(new Font(14));
        scoreText.setX(400);
        scoreText.setY(dimension * scale + 20);
        root.getChildren().add(scoreText);

        // Treasure location text
        treasureLocationText = new Text("Treasure: (" + treasure.getLocation().x + ", " + treasure.getLocation().y + ")");
        treasureLocationText.setFont(new Font(12));
        treasureLocationText.setX(10);
        treasureLocationText.setY(dimension * scale + 45);
        root.getChildren().add(treasureLocationText);

        // Ship position text
        Text shipPosText = new Text("Ship: (" + (int)ship.getShipLocation().x + ", " + (int)ship.getShipLocation().y + ")");
        shipPosText.setFont(new Font(12));
        shipPosText.setX(400);
        shipPosText.setY(dimension * scale + 45);
        root.getChildren().add(shipPosText);
    }

    /**
     * Setup keyboard controls
     */
    private void startSailing() {
        scene.setOnKeyPressed(new EventHandler<KeyEvent>() {
            public void handle(KeyEvent ke) {
                if (gameController.getCurrentState() == GameState.PLAYING) {
                    switch (ke.getCode()) {
                        case RIGHT:
                            ship.goEast(oceanMap);
                            break;
                        case LEFT:
                            ship.goWest(oceanMap);
                            break;
                        case UP:
                            ship.goNorth(oceanMap);
                            break;
                        case DOWN:
                            ship.goSouth(oceanMap);
                            break;
                        default:
                            break;
                    }
                }
                updateDisplay();
            }
        });

        System.out.println("\n===== GAME CONTROLS =====");
        System.out.println("UP ARROW: Move North");
        System.out.println("DOWN ARROW: Move South");
        System.out.println("LEFT ARROW: Move West");
        System.out.println("RIGHT ARROW: Move East");
        System.out.println("========================\n");
    }

    /**
     * Start the game loop - updates game 500ms
     */
    private void startGameLoop() {
        Timeline gameLoop = new Timeline(
            new KeyFrame(
                Duration.millis(500),
                event -> {
                    gameController.update();
                    updateDisplay();
                    checkGameEnd();
                }
            )
        );
        gameLoop.setCycleCount(Animation.INDEFINITE);
        gameLoop.play();
    }

    /**
     * Update all display elements
     */
    private void updateDisplay() {
        // Update ship position
        if (shipImageView != null) {
            shipImageView.setX(ship.getShipLocation().x * scale);
            shipImageView.setY(ship.getShipLocation().y * scale);
        }

        // Update pirate positions
        for (int i = 0; i < pirates.size() && i < pirateImageViews.size(); i++) {
            ImageView view = pirateImageViews.get(i);
            view.setX(pirates.get(i).getLocation().x * scale);
            view.setY(pirates.get(i).getLocation().y * scale);
        }

        // Update monster positions
        for (int i = 0; i < monsters.size() && i < monsterImageViews.size(); i++) {
            ImageView view = monsterImageViews.get(i);
            view.setX(monsters.get(i).getLocation().x * scale);
            view.setY(monsters.get(i).getLocation().y * scale);
        }

        // Update status text
        statusText.setText("Status: " + gameController.getCurrentState().getDescription());
        scoreText.setText("Score: " + gameController.getScore());
    }

    /**
     * Check if game has ended (win or lose)
     */
    private void checkGameEnd() {
        GameState state = gameController.getCurrentState();

        if (state == GameState.WIN) {
            showWinDialog();
        } else if (state == GameState.LOSE) {
            showLoseDialog();
        }
    }

    /**
     * Show win dialog
     */
    private void showWinDialog() {
        Alert alert = new Alert(Alert.AlertType.INFORMATION);
        alert.setTitle("ðŸŽ‰ Victory!");
        alert.setHeaderText("You Found the Treasure!");
        alert.setContentText("Congratulations! You successfully found the treasure and escaped the pirates!\n\n" +
                           "Final Score: " + gameController.getScore());
        alert.show();
        gameController.setGameState(GameState.PAUSED);
    }

    /**
     * Show lose dialog
     */
    private void showLoseDialog() {
        Alert alert = new Alert(Alert.AlertType.INFORMATION);
        alert.setTitle("â˜ ï¸ Defeat!");
        alert.setHeaderText("You Were Caught!");
        alert.setContentText("Oh no! The pirates or a sea monster caught you!\n\n" +
                           "Final Score: " + gameController.getScore());
        alert.show();
        gameController.setGameState(GameState.PAUSED);
    }
}